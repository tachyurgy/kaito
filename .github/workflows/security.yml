name: Security

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger
  pull_request:
    paths:
      - 'Gemfile'
      - 'Gemfile.lock'
      - 'kaito.gemspec'
      - '.github/workflows/security.yml'

jobs:
  bundler-audit:
    name: Bundler Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install bundler-audit
        run: gem install bundler-audit

      - name: Update vulnerability database
        run: bundle audit --update

      - name: Run bundler-audit
        id: audit
        run: |
          set -o pipefail
          bundle audit check --verbose 2>&1 | tee audit_output.txt
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: bundler-audit-results
          path: audit_output.txt
        if: always()

      - name: Check audit results
        run: |
          if [ "${{ steps.audit.outcome }}" == "failure" ]; then
            echo "::error::Security vulnerabilities found! Please review the audit results."
            exit 1
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          warn-on-openssf-scorecard-level: 3

  code-scanning:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ruby
          queries: security-extended

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  gem-vulnerability-check:
    name: Check Gem Vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Check for known vulnerable gems
        run: |
          echo "Checking for known vulnerable gems..."

          # List all gems and their versions
          bundle list --paths > gem_list.txt

          # Check for common vulnerable patterns
          echo "Installed gems:"
          bundle list

          echo "Checking for outdated gems with security vulnerabilities..."
          bundle outdated --strict --only-explicit || true

      - name: Upload gem list
        uses: actions/upload-artifact@v4
        with:
          name: gem-inventory
          path: gem_list.txt

  dependency-update-check:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          bundle outdated --parseable > outdated_gems.txt || true

          if [ -s outdated_gems.txt ]; then
            echo "::warning::The following gems have updates available:"
            cat outdated_gems.txt
          else
            echo "All dependencies are up to date!"
          fi

      - name: Upload outdated gems report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-gems-report
          path: outdated_gems.txt
        if: always()

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [bundler-audit, gem-vulnerability-check, dependency-update-check]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Bundler Audit: ${{ needs.bundler-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Gem Vulnerability Check: ${{ needs.gem-vulnerability-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Update Check: ${{ needs.dependency-update-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.bundler-audit.result }}" == "success" ] && \
             [ "${{ needs.gem-vulnerability-check.result }}" == "success" ]; then
            echo "✅ No security vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Security issues detected. Please review the detailed results." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check overall security status
        run: |
          if [ "${{ needs.bundler-audit.result }}" != "success" ]; then
            echo "::error::Security scan failed! Please review the audit results."
            exit 1
          fi
